name: flaky-rehab-js
on:
  schedule:
    - cron: '0 0 * * MON'  # JST Monday 09:00 AM
  workflow_dispatch:
jobs:
  rehab:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: 
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Run flaky rehabilitation
        run: |
          node tools/rehab_flaky_js.mjs
          echo "Rehabilitation complete"
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet tests/flaky_quarantine.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      - name: Commit and create PR
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(flaky): rehab passed cases - 10 consecutive runs"
          title: "chore(flaky): automatic rehabilitation of stable tests (TypeScript)"
          body: |
            ## Flaky Test Rehabilitation Results (TypeScript)
            
            This PR automatically removes tests from quarantine that passed 10 consecutive runs.
            
            **What changed:**
            - Tests removed from `tests/flaky_quarantine.json`
            - These tests are now back in active CI validation
            
            **Safety:**
            - All removed tests passed 10 consecutive npm test runs
            - If instability returns, they will be re-quarantined automatically
            
            ðŸ¤– Generated by flaky-rehab-js workflow
          branch: "chore/flaky-rehab-js"
          delete-branch: true